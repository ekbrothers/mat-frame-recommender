<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mat Color Recommender</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/node-vibrant/3.1.6/vibrant.min.js"></script>
    <style>
        :root {
            --primary-color: #BB86FC;
            --primary-variant: #3700B3;
            --secondary-color: #03DAC6;
            --background: #121212;
            --surface: #1E1E1E;
            --error: #CF6679;
            --on-primary: #000000;
            --on-background: #FFFFFF;
            --on-surface: #FFFFFF;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--on-background);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
        }

        form {
            background-color: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--background);
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            color: var(--on-background);
        }

        button {
            background-color: var(--primary-color);
            color: var(--on-primary);
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-variant);
        }

        #imagePreview {
            max-width: 100%;
            margin-top: 20px;
        }

        #colorRecommendations, #matPreviews {
            margin-top: 20px;
            background-color: var(--surface);
            padding: 20px;
            border-radius: 8px;
        }

        .color-sample {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid var(--on-surface);
        }

        .mat-preview {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }

        .mat-preview canvas {
            border: 1px solid var(--on-surface);
            max-width: 200px;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mat Color Recommender</h1>
        
        <form id="imageUploadForm">
            <h2>Upload Image</h2>
            <input type="file" id="imageUpload" accept="image/*" required>
            <button type="button" onclick="processImage()">Get Recommendations</button>
        </form>

        <div id="imagePreview"></div>
        <div id="colorRecommendations"></div>
        <div id="matPreviews"></div>
    </div>

    <script>
        function processImage() {
            const input = document.getElementById('imageUpload');
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        document.getElementById('imagePreview').innerHTML = '<img src="' + e.target.result + '" style="max-width: 100%;">';
                        analyzeColors(img);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function analyzeColors(img) {
            console.log("Analyzing colors...");
            Vibrant.from(img.src).getPalette((err, palette) => {
                if (err) {
                    console.error("Error in color analysis:", err);
                    return;
                }
                console.log("Palette:", palette);
                const recommendations = generateRecommendations(palette);
                console.log("Recommendations:", recommendations);
                displayRecommendations(recommendations);
                createMatPreviews(img, recommendations);
            });
        }

        function generateRecommendations(palette) {
            const recommendations = [];
            
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            function getBrightness(rgb) {
                return (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            }

            function getComplementary(hex) {
                const rgb = hexToRgb(hex);
                return `#${(0xFFFFFF ^ (rgb.r << 16 | rgb.g << 8 | rgb.b)).toString(16).padStart(6, '0')}`;
            }

            function getMonochromatic(hex, variation) {
                const rgb = hexToRgb(hex);
                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                hsl.l = Math.max(0, Math.min(1, hsl.l + variation));
                const newRgb = hslToRgb(hsl.h, hsl.s, hsl.l);
                return `#${(newRgb.r << 16 | newRgb.g << 8 | newRgb.b).toString(16).padStart(6, '0')}`;
            }

            function rgbToHsl(r, g, b) {
                r /= 255, g /= 255, b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h, s, l };
            }

            function hslToRgb(h, s, l) {
                let r, g, b;

                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };

                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }

                return {
                    r: Math.round(r * 255),
                    g: Math.round(g * 255),
                    b: Math.round(b * 255)
                };
            }

            const colors = [
                palette.Vibrant,
                palette.LightVibrant,
                palette.DarkVibrant,
                palette.Muted,
                palette.LightMuted,
                palette.DarkMuted
            ].filter(color => color);

            colors.forEach((color, index) => {
                const hex = color.hex;
                const rgb = color.rgb;
                const brightness = getBrightness(rgb);
                
                recommendations.push({ name: `Color ${index + 1} (Original)`, color: hex });
                recommendations.push({ name: `Color ${index + 1} (Complementary)`, color: getComplementary(hex) });
                recommendations.push({ name: `Color ${index + 1} (Lighter)`, color: getMonochromatic(hex, 0.2) });
                recommendations.push({ name: `Color ${index + 1} (Darker)`, color: getMonochromatic(hex, -0.2) });
                
                if (brightness > 128) {
                    recommendations.push({ name: 'Neutral (Dark)', color: '#303030' });
                } else {
                    recommendations.push({ name: 'Neutral (Light)', color: '#E0E0E0' });
                }
            });

            recommendations.push({ name: 'Classic White', color: '#FFFFFF' });
            recommendations.push({ name: 'Off-White', color: '#F5F5F5' });
            recommendations.push({ name: 'Light Gray', color: '#D3D3D3' });
            recommendations.push({ name: 'Charcoal', color: '#36454F' });
            recommendations.push({ name: 'Black', color: '#000000' });

            return recommendations;
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('colorRecommendations');
            container.innerHTML = '<h2>Recommended Mat Colors</h2>';
            recommendations.forEach(rec => {
                container.innerHTML += `
                    <div>
                        <span class="color-sample" style="background-color: ${rec.color};"></span>
                        ${rec.name}: ${rec.color}
                    </div>
                `;
            });
        }

        function createMatPreviews(img, recommendations) {
            const container = document.getElementById('matPreviews');
            container.innerHTML = '<h2>Mat Color Previews</h2>';
            recommendations.forEach(rec => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const matWidth = 50; // Width of mat border
                
                const scaleFactor = Math.min(300 / img.width, 300 / img.height);
                const scaledWidth = img.width * scaleFactor;
                const scaledHeight = img.height * scaleFactor;
                
                canvas.width = scaledWidth + (matWidth * 2);
                canvas.height = scaledHeight + (matWidth * 2);

                // Draw mat
                ctx.fillStyle = rec.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw image
                ctx.drawImage(img, matWidth, matWidth, scaledWidth, scaledHeight);

                container.innerHTML += `
                    <div class="mat-preview">
                        <canvas width="${canvas.width}" height="${canvas.height}"></canvas>
                        <p>${rec.name}</p>
                    </div>
                `;
                container.lastElementChild.querySelector('canvas').getContext('2d').drawImage(canvas, 0, 0);
            });
        }
    </script>
</body>
</html>
